from celery import shared_task
import requests,json
from pentest.models import Test, Payload
from urllib.parse import urlparse
from datetime import datetime

@shared_task
def WeakSSLTest(url, id):
    #get domain from url
    domain = urlparse(url).netloc
    data = {"query":"\n    mutation tlsChecker($input: ServerSecurityInput!) {\n  serverSecurityProtocols(input: $input) {\n    name\n    capability\n  }\n}\n    ","variables":{"input":{"domain":f"{domain}"}}}
    r = requests.post("https://jarvis.cdn77.com/graphql", json=data)
    resp = r.json()['data']['serverSecurityProtocols']

    tls_dict = {}
    for r in resp:
        if r['name'] == 'TLS1':
            tls_dict['TLS1'] = r['capability']
        elif r['name'] == 'TLS1_1':
            tls_dict['TLS1_1'] = r['capability']
        elif r['name'] == 'TLS1_2':
            tls_dict['TLS1_2'] = r['capability']
        elif r['name'] == 'TLS1_3':
            tls_dict['TLS_3'] = r['capability']
    
    r = requests.get("https://jsonplaceholder.typicode.com/posts")

    if "TLS1" in tls_dict and tls_dict['TLS1'] == "offered":
        Payload.objects.create(payload_string="Website is still using TLS 1.0", test_id=id)
    if "TLS1_1" in tls_dict and tls_dict['TLS1_1'] == "offered":
        Payload.objects.create(payload_string="Website is still using TLS 1.1", test_id = id)
    if len(tls_dict) == 0 :
        Payload.objects.create(
            payload_string="Website doesn't use https",
            test_id = id)
    
    Test.objects.filter(pk=id).update(end_time=datetime.now())