from celery import shared_task
from pentest.helpers.utils import RequestWrapper, finishTest
import re


@shared_task
def RateLimitTest(url, test_id, request_method, headers, data_format, body, validCreds) :
    with open('pentest/helpers/top-100-passwords.txt') as f :
        wordlist = f.read().splitlines()

    for w in wordlist:
        u = re.sub(r"(?<!\\)\$", str(validCreds + w), url)
        u = re.sub(r"\\\$", "$", u)

        b = re.sub(r"(?<!\\)\$", str(validCreds + w), body)
        b = re.sub(r"\\\$", "$", b)

        req = RequestWrapper(u, request_method, headers, data_format, b)

        print(req.request.text)
    
    u = re.sub(r"(?<!\\)\$", str(validCreds), url)
    u = re.sub(r"\\\$", "$", u)

    b = re.sub(r"(?<!\\)\$", str(validCreds), body)
    b = re.sub(r"\\\$", "$", b)

    r = RequestWrapper(u, request_method, headers, data_format, b)

    r.saveRequestAsPayload(
        payload_string = f"Brute Force Result",
        test_id = test_id
    )

    finishTest(test_id)