from celery import shared_task
from pentest.models import Test, Payload
from pentest.helpers.utils import RequestWrapper, finishTest

def getHTTPURL(url) :
    get_url = url.split(':')[1]
    http_url = "http:" + get_url
    return http_url

@shared_task
def HSTSTest(url,headers,request_method,data_format,body,test_id):
    

    https_req = RequestWrapper(url, request_method, headers, data_format, body)
    http_req = RequestWrapper(getHTTPURL(url), request_method, headers, data_format, body)
    
    if https_req.request.text == http_req.request.text or http_req.request.status_code == 200:
        http_req.saveRequestAsPayload(
            payload_string = "Non-secure requests are not automatically upgraded to HTTPS",
            test_id = test_id)

    finishTest(test_id)
