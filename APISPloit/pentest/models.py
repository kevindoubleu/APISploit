from django.db import models
import json
# Create your models here.
class Scan(models.Model):
    url = models.TextField()
    request_method = models.CharField(max_length=10)
    def __str__(self):
        return self.url + " at " + str(self.start_time)

class Test(models.Model):
    test_name = models.CharField(max_length=60)
    start_time = models.DateTimeField(auto_now_add=True)
    end_time = models.DateTimeField(null=True)
    scan = models.ForeignKey(Scan, on_delete=models.CASCADE, related_name="tests")
    def __str__(self):
        return self.test_name + " at " + self.scan.url

    def status(self):
        if self.start_time and self.end_time:
            return "Completed"
        elif self.start_time:
            return "Scanning"
        else:
            return "Queued"
        
    def success(self):
        return len(self.payloads.all()) > 0

class Payload(models.Model):
    payload_string = models.TextField(blank=True)
    request_header = models.TextField(null=True)
    request_body = models.TextField(null=True)
    response_header = models.TextField(null=True)
    response_body = models.TextField(null=True)
    test = models.ForeignKey(Test, on_delete=models.CASCADE, related_name="payloads")

    @staticmethod
    def _dict_str_to_lines(dict_str):
        if dict_str is None or len(dict_str) == 0:
            return "None"
        else:
            lines = ""
            for key in dict_str:
                lines += f"{key}: {dict_str[key]}\n"
            return lines

    def request_header_lines(self):
        return Payload._dict_str_to_lines(self.request_header)
    
    def response_header_lines(self):
        return Payload._dict_str_to_lines(self.response_header)

    def __str__(self):
        return self.payload_string + " on " + self.test.scan.url
    