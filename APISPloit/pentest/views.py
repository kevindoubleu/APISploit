from datetime import datetime
from django.http.response import JsonResponse
from django.shortcuts import render, get_object_or_404, get_list_or_404
from .models import Scan, Test
import os
from rest_framework.parsers import JSONParser
from .validator import validateData
from django.views.decorators.csrf import csrf_exempt
from .tasks.ssl import WeakSSLTest
import requests

@csrf_exempt
# Create your views here.
def home(request):
    if request.method == "GET" :
        ip = os.getenv("IP_ADDRESS")
        return render(request, 'pentest/index.html', {
            "url" : ip
        })
    elif request.method == "POST":
        data = JSONParser().parse(request)

        responseData = {
            "message" : "Scanning has been successfully entered into the queue. You can check the progress of the queue in /history"
        }
        result = validateData(data)

        if result['status'] != 200 :
            return JsonResponse({"message" : result['message']}, status=result['status'])

        #coba insert scan
        s = Scan.objects.create(url = data['url'], request_method = data['request_method'])
    
        newTests = {}

        for t in data['vulns'] :
            test = Test.objects.create(test_name = t, scan_id = s.id)
            newTests[t] = test.id

        #update scans kalau udah selesai    
        # Scan.objects.filter(pk=2).update(end_time=datetime.now())

        
        if "Weak SSL" in data['vulns'] : 
            WeakSSLTest.delay(data['url'], newTests["Weak SSL"])
       

        return JsonResponse(responseData)

def history(request):
    tests = Test.objects.all()
    context = {
        'tests': tests
    }
    return render(request, 'pentest/history.html', context)

def detail(request, test_id):
    test_obj = get_object_or_404(Test, pk=test_id)
    context = {
        'test': test_obj
    }
    return render(request, 'pentest/detail.html', context)
